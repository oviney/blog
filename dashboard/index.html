<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playwright Healing Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .logo {
            color: #E3120B;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #E3120B;
        }
        .metric-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .metric-change {
            font-size: 0.9em;
            margin-top: 5px;
        }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .chart-container {
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        .status {
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 500;
            text-align: center;
            margin: 20px 0;
        }
        .status.healthy {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .last-updated {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 30px;
        }
        canvas {
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üìä Healing Dashboard</div>
            <div class="subtitle">Playwright Test Healing Monitor</div>
        </div>

        <div id="loading" class="loading">
            Loading dashboard data...
        </div>

        <div id="dashboard" style="display: none;">
            <div class="metrics" id="metrics"></div>

            <div id="status-indicator"></div>

            <div class="chart-container">
                <div class="chart-title">Healing Success Rate Trend</div>
                <canvas id="successChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Test Results Over Time</div>
                <canvas id="resultsChart"></canvas>
            </div>

            <div class="last-updated" id="lastUpdated"></div>
        </div>
    </div>

    <script>
        let successChart = null;
        let resultsChart = null;

        async function loadDashboardData() {
            try {
                // Try to fetch data from GitHub Actions artifacts via GitHub API
                console.log('Attempting to fetch dashboard data...');
                const response = await fetch('./dashboard-data.json?v=' + Date.now());
                console.log('Fetch response status:', response.status, response.statusText);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Successfully loaded real data:', data);
                    updateDashboard(data);
                } else {
                    console.log('Fetch failed, status:', response.status, 'Loading demo data...');
                    // Fallback to demo data for development/preview
                    loadDemoData();
                }
            } catch (error) {
                console.log('Fetch error:', error, 'Loading demo data for preview');
                loadDemoData();
            }
        }

        function loadDemoData() {
            const demoData = {
                timestamp: new Date().toISOString(),
                metrics: {
                    totalTests: 135,
                    passingTests: 128,
                    healingSuccessRate: 94.8,
                    lastRunDuration: 284
                },
                trend: [
                    { date: '2026-01-10', successRate: 89.2, totalTests: 130, passingTests: 116 },
                    { date: '2026-01-11', successRate: 91.5, totalTests: 132, passingTests: 121 },
                    { date: '2026-01-12', successRate: 93.1, totalTests: 134, passingTests: 125 },
                    { date: '2026-01-13', successRate: 94.8, totalTests: 135, passingTests: 128 }
                ],
                status: 'healthy'
            };
            updateDashboard(demoData);
        }

        function updateDashboard(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            updateMetrics(data.metrics);
            updateStatus(data.status, data.metrics);
            updateCharts(data.trend);
            updateLastUpdated(data.timestamp);
        }

        function updateMetrics(metrics) {
            const metricsContainer = document.getElementById('metrics');
            const failureRate = ((metrics.totalTests - metrics.passingTests) / metrics.totalTests * 100).toFixed(1);

            metricsContainer.innerHTML = `
                <div class="metric-card">
                    <div class="metric-title">Success Rate</div>
                    <div class="metric-value">${metrics.healingSuccessRate.toFixed(1)}%</div>
                    <div class="metric-change positive">Target: 95%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Passing Tests</div>
                    <div class="metric-value">${metrics.passingTests}/${metrics.totalTests}</div>
                    <div class="metric-change ${failureRate < 5 ? 'positive' : 'negative'}">${failureRate}% failure rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Last Run</div>
                    <div class="metric-value">${metrics.lastRunDuration}s</div>
                    <div class="metric-change">Execution time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Healing Status</div>
                    <div class="metric-value">${metrics.healingSuccessRate >= 95 ? '‚úÖ' : metrics.healingSuccessRate >= 90 ? '‚ö†Ô∏è' : '‚ùå'}</div>
                    <div class="metric-change">${metrics.healingSuccessRate >= 95 ? 'Excellent' : metrics.healingSuccessRate >= 90 ? 'Good' : 'Needs attention'}</div>
                </div>
            `;
        }

        function updateStatus(status, metrics) {
            const statusContainer = document.getElementById('status-indicator');
            let statusClass = 'healthy';
            let statusMessage = 'All systems operational';

            if (metrics.healingSuccessRate < 90) {
                statusClass = 'error';
                statusMessage = 'Healing success rate below target - requires investigation';
            } else if (metrics.healingSuccessRate < 95) {
                statusClass = 'warning';
                statusMessage = 'Healing success rate approaching target threshold';
            }

            statusContainer.innerHTML = `<div class="status ${statusClass}">${statusMessage}</div>`;
        }

        function updateCharts(trendData) {
            const dates = trendData.map(d => d.date);
            const successRates = trendData.map(d => d.successRate);
            const passingTests = trendData.map(d => d.passingTests);
            const totalTests = trendData.map(d => d.totalTests);

            // Success Rate Trend Chart
            const successCtx = document.getElementById('successChart').getContext('2d');
            if (successChart) successChart.destroy();

            successChart = new Chart(successCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Healing Success Rate',
                        data: successRates,
                        borderColor: '#E3120B',
                        backgroundColor: 'rgba(227, 18, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: '95% Target',
                        data: dates.map(() => 95),
                        borderColor: '#28a745',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 80,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Test Results Chart
            const resultsCtx = document.getElementById('resultsChart').getContext('2d');
            if (resultsChart) resultsChart.destroy();

            resultsChart = new Chart(resultsCtx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Passing Tests',
                        data: passingTests,
                        backgroundColor: '#28a745'
                    }, {
                        label: 'Failing Tests',
                        data: totalTests.map((total, i) => total - passingTests[i]),
                        backgroundColor: '#dc3545'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateLastUpdated(timestamp) {
            const lastUpdatedElement = document.getElementById('lastUpdated');
            const date = new Date(timestamp);
            lastUpdatedElement.textContent = `Last updated: ${date.toLocaleString()}`;
        }

        // Auto-refresh every 5 minutes
        function startAutoRefresh() {
            setInterval(loadDashboardData, 5 * 60 * 1000);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            startAutoRefresh();
        });
    </script>
</body>
</html>
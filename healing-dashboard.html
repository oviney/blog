<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playwright Healing Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            line-height: 1.6;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            color: #E3120B;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .last-update {
            color: #999;
            font-size: 0.9rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-value.success { color: #28a745; }
        .metric-value.warning { color: #ffc107; }
        .metric-value.danger { color: #dc3545; }

        .metric-label {
            color: #999;
            font-size: 0.9rem;
        }

        .trend-indicator {
            display: inline-block;
            margin-left: 8px;
            font-size: 1.2rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            color: #E3120B;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .status-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-title {
            color: #E3120B;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-indicator.healthy { background: #28a745; }
        .status-indicator.warning { background: #ffc107; color: #000; }
        .status-indicator.critical { background: #dc3545; }

        .failed-tests {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }

        .failed-test-item {
            background: #2a1a1a;
            border-left: 3px solid #dc3545;
            padding: 10px;
            margin: 10px 0;
            border-radius: 0 4px 4px 0;
        }

        .auto-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #E3120B;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .auto-refresh:hover {
            background: #c20f0a;
        }

        .loading {
            text-align: center;
            color: #999;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ðŸŽ­ Playwright Healing Monitor</h1>
            <div class="last-update" id="lastUpdate">Loading...</div>
        </div>

        <button class="auto-refresh" onclick="toggleAutoRefresh()" id="refreshBtn">Auto-Refresh: OFF</button>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Overall Success Rate</div>
                <div class="metric-value" id="overallSuccess">--%</div>
                <div class="trend-indicator" id="overallTrend"></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Playwright Tests</div>
                <div class="metric-value" id="playwrightTests">--/--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Visual Tests</div>
                <div class="metric-value" id="visualTests">--/--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Average Success (10 runs)</div>
                <div class="metric-value" id="averageSuccess">--%</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Success Rate Trend (Last 20 Runs)</div>
                <canvas id="trendChart" width="400" height="200"></canvas>
            </div>
            <div class="status-panel">
                <div class="status-title">System Status</div>
                <div class="status-item">
                    <span>Overall Health</span>
                    <span class="status-indicator" id="overallStatus">UNKNOWN</span>
                </div>
                <div class="status-item">
                    <span>Playwright Suite</span>
                    <span class="status-indicator" id="playwrightStatus">UNKNOWN</span>
                </div>
                <div class="status-item">
                    <span>Visual Suite</span>
                    <span class="status-indicator" id="visualStatus">UNKNOWN</span>
                </div>
                <div class="status-item">
                    <span>Trend Direction</span>
                    <span class="status-indicator" id="trendStatus">UNKNOWN</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Test Suite Breakdown</div>
            <canvas id="breakdownChart" width="400" height="200"></canvas>
        </div>

        <div class="failed-tests" id="failedTestsContainer" style="display: none;">
            <div class="status-title">Failed Tests</div>
            <div id="failedTestsList"></div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let trendChart = null;
        let breakdownChart = null;

        const API_BASE = '';

        async function loadMetrics() {
            try {
                // Load cumulative metrics
                const response = await fetch('./healing-metrics/cumulative.json');
                if (!response.ok) {
                    throw new Error(`Failed to load metrics: ${response.status}`);
                }

                const data = await response.json();
                updateDashboard(data);

            } catch (error) {
                console.error('Failed to load metrics:', error);
                document.getElementById('lastUpdate').textContent = `Error: ${error.message}`;
            }
        }

        async function loadLatestRun() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`./healing-metrics/${today}.json`);

                if (!response.ok) {
                    return null;
                }

                const dailyData = await response.json();
                return dailyData[dailyData.length - 1]; // Latest run of the day

            } catch (error) {
                console.warn('No daily data available:', error);
                return null;
            }
        }

        function updateDashboard(data) {
            const summary = data.summary || {};
            const runs = data.runs || [];
            const latestRun = runs[runs.length - 1];

            // Update timestamps
            document.getElementById('lastUpdate').textContent =
                `Last updated: ${summary.lastUpdate ? new Date(summary.lastUpdate).toLocaleString() : 'Unknown'}`;

            // Update metrics
            document.getElementById('overallSuccess').textContent =
                `${summary.currentSuccessRate || 0}%`;
            document.getElementById('averageSuccess').textContent =
                `${summary.averageSuccessRate || 0}%`;

            // Update trend indicator
            const trendElement = document.getElementById('overallTrend');
            const trendIcon = summary.trend === 'improving' ? 'ðŸ“ˆ' :
                             summary.trend === 'degrading' ? 'ðŸ“‰' : 'âž¡ï¸';
            trendElement.textContent = trendIcon;

            // Color-code success rates
            updateSuccessRateColor('overallSuccess', summary.currentSuccessRate);

            // Update test counts
            if (latestRun) {
                document.getElementById('playwrightTests').textContent =
                    `${latestRun.playwrightPassed}/${latestRun.playwrightPassed + latestRun.playwrightFailed}`;
                document.getElementById('visualTests').textContent =
                    `${latestRun.visualPassed}/${latestRun.visualPassed + latestRun.visualFailed}`;
            }

            // Update status indicators
            updateStatusIndicators(summary, latestRun);

            // Update charts
            updateTrendChart(runs);
            updateBreakdownChart(latestRun);

            // Load and display failed tests
            loadFailedTests();
        }

        function updateSuccessRateColor(elementId, rate) {
            const element = document.getElementById(elementId);
            element.className = 'metric-value';

            if (rate >= 81.1) {
                element.classList.add('success');
            } else if (rate >= 75) {
                element.classList.add('warning');
            } else {
                element.classList.add('danger');
            }
        }

        function updateStatusIndicators(summary, latestRun) {
            // Overall status
            const overallRate = summary.currentSuccessRate || 0;
            updateStatusIndicator('overallStatus',
                overallRate >= 81.1 ? 'HEALTHY' : overallRate >= 75 ? 'WARNING' : 'CRITICAL');

            // Playwright status
            if (latestRun) {
                const playwrightRate = (latestRun.playwrightPassed / (latestRun.playwrightPassed + latestRun.playwrightFailed)) * 100;
                updateStatusIndicator('playwrightStatus',
                    playwrightRate >= 90 ? 'HEALTHY' : playwrightRate >= 80 ? 'WARNING' : 'CRITICAL');

                const visualRate = (latestRun.visualPassed / (latestRun.visualPassed + latestRun.visualFailed)) * 100;
                updateStatusIndicator('visualStatus',
                    visualRate === 100 ? 'HEALTHY' : 'CRITICAL');
            }

            // Trend status
            const trend = summary.trend || 'stable';
            updateStatusIndicator('trendStatus',
                trend === 'improving' ? 'HEALTHY' : trend === 'degrading' ? 'WARNING' : 'STABLE');
        }

        function updateStatusIndicator(elementId, status) {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.className = 'status-indicator';

            switch(status) {
                case 'HEALTHY':
                case 'STABLE':
                    element.classList.add('healthy');
                    break;
                case 'WARNING':
                    element.classList.add('warning');
                    break;
                case 'CRITICAL':
                    element.classList.add('critical');
                    break;
            }
        }

        function updateTrendChart(runs) {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChart) {
                trendChart.destroy();
            }

            const last20Runs = runs.slice(-20);
            const labels = last20Runs.map((run, index) => {
                const date = new Date(run.timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            });
            const successRates = last20Runs.map(run => run.successRate);

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: successRates,
                        borderColor: '#E3120B',
                        backgroundColor: 'rgba(227, 18, 11, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.max(0, Math.min(...successRates) - 5),
                            max: 100,
                            ticks: {
                                color: '#999999'
                            },
                            grid: {
                                color: '#333333'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#999999',
                                maxRotation: 45
                            },
                            grid: {
                                color: '#333333'
                            }
                        }
                    }
                }
            });
        }

        function updateBreakdownChart(latestRun) {
            const ctx = document.getElementById('breakdownChart').getContext('2d');

            if (breakdownChart) {
                breakdownChart.destroy();
            }

            if (!latestRun) return;

            breakdownChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Playwright Passed', 'Playwright Failed', 'Visual Passed', 'Visual Failed'],
                    datasets: [{
                        data: [
                            latestRun.playwrightPassed,
                            latestRun.playwrightFailed,
                            latestRun.visualPassed,
                            latestRun.visualFailed
                        ],
                        backgroundColor: ['#28a745', '#dc3545', '#17a2b8', '#ffc107'],
                        borderWidth: 2,
                        borderColor: '#1a1a1a'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        async function loadFailedTests() {
            try {
                const latestData = await loadLatestRun();
                if (!latestData || !latestData.suites.playwright.failedTests || latestData.suites.playwright.failedTests.length === 0) {
                    document.getElementById('failedTestsContainer').style.display = 'none';
                    return;
                }

                const failedTests = latestData.suites.playwright.failedTests;
                const container = document.getElementById('failedTestsContainer');
                const list = document.getElementById('failedTestsList');

                list.innerHTML = '';
                failedTests.forEach(test => {
                    const item = document.createElement('div');
                    item.className = 'failed-test-item';
                    item.innerHTML = `
                        <strong>${test.title}</strong> <em>(${test.file})</em><br>
                        <small>${test.error}</small>
                    `;
                    list.appendChild(item);
                });

                container.style.display = 'block';
            } catch (error) {
                console.warn('Could not load failed tests:', error);
                document.getElementById('failedTestsContainer').style.display = 'none';
            }
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('refreshBtn');

            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = 'Auto-Refresh: OFF';
                btn.style.background = '#E3120B';
            } else {
                autoRefreshInterval = setInterval(loadMetrics, 30000); // Refresh every 30 seconds
                btn.textContent = 'Auto-Refresh: ON';
                btn.style.background = '#28a745';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadMetrics();

            // Refresh button
            const refreshBtn = document.createElement('button');
            refreshBtn.textContent = 'Refresh Now';
            refreshBtn.style.position = 'fixed';
            refreshBtn.style.top = '70px';
            refreshBtn.style.right = '20px';
            refreshBtn.style.background = '#17a2b8';
            refreshBtn.style.color = 'white';
            refreshBtn.style.border = 'none';
            refreshBtn.style.padding = '8px 12px';
            refreshBtn.style.borderRadius = '4px';
            refreshBtn.style.cursor = 'pointer';
            refreshBtn.style.fontSize = '0.9rem';
            refreshBtn.onclick = loadMetrics;
            document.body.appendChild(refreshBtn);
        });
    </script>
</body>
</html>
name: Generate Economist-Style Blog Post

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Article topic'
        required: true
        type: string
      talking_points:
        description: 'Key data/angles to cover (comma-separated)'
        required: false
        type: string
      category:
        description: 'Category'
        required: true
        type: choice
        options:
          - quality-engineering
          - test-automation
          - performance-engineering
          - software-engineering
          - ai
  
  schedule:
    # Every Monday at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  generate-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic python-slugify matplotlib numpy
          # Install fonts for chart generation
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core
      
      - name: Run Economist Agent Pipeline
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TOPIC: ${{ github.event.inputs.topic || '' }}
          TALKING_POINTS: ${{ github.event.inputs.talking_points || '' }}
          CATEGORY: ${{ github.event.inputs.category || 'quality-engineering' }}
        run: python scripts/economist_agent.py
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "article: ${{ github.event.inputs.topic || 'Weekly post' }}"
          branch: draft/article-${{ github.run_number }}
          title: "ðŸ“° ${{ github.event.inputs.topic || 'Weekly Article' }}"
          body: |
            ## Economist-Style Article Generated
            
            **Topic:** ${{ github.event.inputs.topic || 'From content queue' }}
            **Category:** ${{ github.event.inputs.category || 'quality-engineering' }}
            
            ### Agent Pipeline Completed
            - [x] Research Agent: Data gathering & source identification
            - [x] Graphics Agent: Economist-style chart generation
            - [x] Writer Agent: First draft with data integration
            - [x] Editor Agent: Style polish & quality review
            
            ### Review Checklist
            - [ ] Data accuracy verified
            - [ ] Chart renders correctly
            - [ ] Voice matches Economist style
            - [ ] Personal insights added (optional)
            
            ---
            *Generated by Economist Agent Pipeline*
          labels: economist-style, auto-generated, needs-review

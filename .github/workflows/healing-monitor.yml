name: üé≠ Playwright Healing Success Monitor

on:
  schedule:
    # Run every 4 hours for active monitoring
    - cron: '0 */4 * * *'
  push:
    branches: [ main ]
    paths:
      - 'tests/playwright-agents/**'
      - 'scripts/healing-monitor.js'
      - 'scripts/alert-system.js'
      - '.github/workflows/healing-monitor.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'tests/playwright-agents/**'
      - 'scripts/healing-monitor.js'
      - 'scripts/alert-system.js'
  workflow_dispatch:
    inputs:
      force_analysis:
        description: 'Force deep healing analysis'
        required: false
        default: 'false'
        type: boolean
      alert_webhooks:
        description: 'Send alerts to configured webhooks'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_ENV: production
  CI: true
  HEALING_WEBHOOK_URL: ${{ secrets.HEALING_WEBHOOK_URL }}

jobs:
  monitor-healing:
    name: üîç Healing Effectiveness Monitor
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      success-rate: ${{ steps.monitor.outputs.success-rate }}
      trend: ${{ steps.monitor.outputs.trend }}
      status: ${{ steps.monitor.outputs.status }}

    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üöÄ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üíé Setup Ruby and Bundler
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3'
        bundler-cache: true

    - name: üì¶ Install dependencies
      run: |
        npm ci --include=dev
        npx playwright install --with-deps chromium

    - name: ‚úÖ Verify Playwright installation
      run: |
        npx playwright --version
        npx playwright install-deps

    - name: üèóÔ∏è Build Jekyll site
      run: bundle exec jekyll build

    - name: üåê Start Jekyll server
      run: |
        # Create log file for Jekyll output
        JEKYLL_LOG="/tmp/jekyll-server.log"
        
        echo "üöÄ Starting Jekyll server..."
        
        # Start Jekyll server with output capture
        bundle exec jekyll serve --port 4000 > "$JEKYLL_LOG" 2>&1 &
        JEKYLL_PID=$!
        
        echo "Jekyll process started with PID: $JEKYLL_PID"
        
        # Verify the process is still running after a brief moment
        sleep 2
        if ! kill -0 $JEKYLL_PID 2>/dev/null; then
          echo "‚ùå ERROR: Jekyll process died immediately after starting"
          echo "=== Jekyll logs ==="
          cat "$JEKYLL_LOG"
          exit 1
        fi
        
        echo "‚úÖ Jekyll process is running, waiting for server to be ready..."
        
        # Wait for server with extended timeout (60 attempts = 120 seconds)
        for i in {1..60}; do
          # Check if process is still alive
          if ! kill -0 $JEKYLL_PID 2>/dev/null; then
            echo "‚ùå ERROR: Jekyll process crashed during startup (attempt $i/60)"
            echo "=== Last 100 lines of Jekyll logs ==="
            tail -100 "$JEKYLL_LOG"
            echo "=== Port 4000 status ==="
            (netstat -tuln 2>/dev/null || ss -tuln 2>/dev/null) | grep 4000 || echo "Port 4000 not in use"
            exit 1
          fi
          
          # Check if server is responding
          if curl -f -s http://localhost:4000/ > /dev/null 2>&1; then
            echo "‚úÖ Jekyll server is ready and responding (attempt $i/60)"
            echo "=== Server startup logs ==="
            tail -50 "$JEKYLL_LOG"
            break
          fi
          
          # Provide progress feedback
          if [ $((i % 15)) -eq 0 ]; then
            echo "Still waiting for server... attempt $i/60 ($(($i * 2))s elapsed)"
            echo "Process status: $(ps -p $JEKYLL_PID -o pid,stat,etime,cmd --no-headers || echo 'Process not found')"
          fi
          
          sleep 2
        done
        
        # Check if server started successfully
        if ! curl -f -s http://localhost:4000/ > /dev/null 2>&1; then
          echo "‚ùå ERROR: Jekyll server failed to respond after 120 seconds"
          echo "=== Jekyll process status ==="
          ps aux | grep jekyll || echo "No Jekyll processes found"
          echo "=== Port 4000 status ==="
          (netstat -tuln 2>/dev/null || ss -tuln 2>/dev/null) | grep 4000 || echo "Port 4000 not in use"
          echo "=== Last 100 lines of Jekyll logs ==="
          tail -100 "$JEKYLL_LOG"
          echo "=== Directory permissions ==="
          ls -la _site/ || echo "_site directory not created"
          exit 1
        fi
        
        echo "Server fully initialized, waiting 1 more second for stability..."
        sleep 1
        
        # Save Jekyll PID for cleanup
        echo "$JEKYLL_PID" > /tmp/jekyll.pid

    - name: üéØ Run comprehensive healing monitoring
      id: monitor
      run: |
        echo "Running healing monitoring suite..."
        npm run monitoring:full

        # Extract metrics for workflow outputs
        SUCCESS_RATE=$(node -e "
          const fs = require('fs');
          try {
            const data = JSON.parse(fs.readFileSync('healing-metrics/cumulative.json', 'utf8'));
            console.log(data.summary.currentSuccessRate || 0);
          } catch(e) { console.log(0); }
        ")

        TREND=$(node -e "
          const fs = require('fs');
          try {
            const data = JSON.parse(fs.readFileSync('healing-metrics/cumulative.json', 'utf8'));
            console.log(data.summary.trend || 'unknown');
          } catch(e) { console.log('unknown'); }
        ")

        STATUS="healthy"
        if (( $(echo "$SUCCESS_RATE < 75" | bc -l) )); then
          STATUS="critical"
        elif (( $(echo "$SUCCESS_RATE < 81.1" | bc -l) )); then
          STATUS="warning"
        fi

        echo "success-rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
        echo "trend=$TREND" >> $GITHUB_OUTPUT
        echo "status=$STATUS" >> $GITHUB_OUTPUT

        echo "‚úÖ Monitoring complete: $SUCCESS_RATE% success rate ($STATUS)"
      env:
        CI: true
        NODE_ENV: production

    - name: üìä Generate comprehensive reports
      run: |
        echo "Generating healing trend analysis..."
        npm run analyze:healing-trends

        echo "Analyzing failure patterns..."
        npm run analyze:failures

        echo "Checking for healing degradation..."
        npm run alert:system

    - name: üîç Validate healing effectiveness
      run: |
        echo "Validating healing patterns..."

        # Check if we have enough data points
        TOTAL_RUNS=$(node -e "
          const fs = require('fs');
          try {
            const data = JSON.parse(fs.readFileSync('healing-metrics/cumulative.json', 'utf8'));
            console.log(data.summary.totalRuns || 0);
          } catch(e) { console.log(0); }
        ")

        if [ "$TOTAL_RUNS" -lt 3 ]; then
          echo "‚ö†Ô∏è Not enough data points for trend analysis ($TOTAL_RUNS runs)"
        else
          echo "üìà Sufficient data for analysis ($TOTAL_RUNS runs)"
        fi

    - name: üì§ Upload comprehensive healing data
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: healing-data-${{ github.run_number }}-${{ steps.monitor.outputs.success-rate }}pct
        path: |
          healing-metrics/
          healing-reports/
          healing-alerts/
          playwright-report/
          test-results/
        retention-days: 90

    - name: üõë Stop Jekyll server
      if: always()
      run: |
        if [ -f /tmp/jekyll.pid ]; then
          JEKYLL_PID=$(cat /tmp/jekyll.pid)
          if kill -0 $JEKYLL_PID 2>/dev/null; then
            echo "Stopping Jekyll server (PID: $JEKYLL_PID)"
            kill $JEKYLL_PID || true
            sleep 2
            # Force kill if still running after graceful shutdown attempt
            if kill -0 $JEKYLL_PID 2>/dev/null; then
              echo "Process still running, forcing termination..."
              kill -9 $JEKYLL_PID 2>/dev/null || true
            else
              echo "Process terminated gracefully"
            fi
          fi
        fi
        
        # Clean up any orphaned Jekyll processes
        pkill -f "jekyll serve" || true
        
        echo "‚úÖ Jekyll server cleanup complete"

    - name: üìä Create healing status badge
      run: |
        SUCCESS_RATE="${{ steps.monitor.outputs.success-rate }}"
        STATUS="${{ steps.monitor.outputs.status }}"
        TREND="${{ steps.monitor.outputs.trend }}"

        # Create badge data
        mkdir -p .github/badges

        # Success rate badge
        if [ "$STATUS" = "healthy" ]; then
          COLOR="brightgreen"
        elif [ "$STATUS" = "warning" ]; then
          COLOR="yellow"
        else
          COLOR="red"
        fi

        echo "{
          \"schemaVersion\": 1,
          \"label\": \"healing success\",
          \"message\": \"${SUCCESS_RATE}%\",
          \"color\": \"$COLOR\"
        }" > .github/badges/healing-success.json

        # Trend badge
        TREND_COLOR="blue"
        if [ "$TREND" = "improving" ]; then
          TREND_COLOR="brightgreen"
          TREND_ICON="üìà"
        elif [ "$TREND" = "degrading" ]; then
          TREND_COLOR="orange"
          TREND_ICON="üìâ"
        else
          TREND_ICON="‚û°Ô∏è"
        fi

        echo "{
          \"schemaVersion\": 1,
          \"label\": \"trend\",
          \"message\": \"$TREND_ICON $TREND\",
          \"color\": \"$TREND_COLOR\"
        }" > .github/badges/healing-trend.json

        echo "Created status badges with $SUCCESS_RATE% success rate ($STATUS trend: $TREND)"

    - name: üíæ Commit healing data (if on main branch)
      if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      run: |
        git config --local user.email "healing-monitor@github.com"
        git config --local user.name "üé≠ Healing Monitor"

        # Add healing data
        git add healing-metrics/ healing-reports/ healing-alerts/ .github/badges/ || true

        if ! git diff --staged --quiet; then
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "üìä healing: ${{ steps.monitor.outputs.success-rate }}% success rate (${{ steps.monitor.outputs.trend }}) - $TIMESTAMP

          - Success Rate: ${{ steps.monitor.outputs.success-rate }}%
          - Trend: ${{ steps.monitor.outputs.trend }}
          - Status: ${{ steps.monitor.outputs.status }}
          - Workflow: ${{ github.run_id }}

          Co-Authored-By: Healing Monitor <healing-monitor@github.com>"

          git push || echo "‚ö†Ô∏è Failed to push healing data (may be protected branch)"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi

    - name: üö® Send webhook alert (if configured)
      if: inputs.alert_webhooks == 'true' && env.HEALING_WEBHOOK_URL && (steps.monitor.outputs.status == 'critical' || steps.monitor.outputs.status == 'warning')
      run: |
        curl -X POST "$HEALING_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "alert_type": "${{ steps.monitor.outputs.status }}",
            "severity": "${{ steps.monitor.outputs.status == 'critical' && 'high' || 'medium' }}",
            "title": "üé≠ Healing Success Rate Alert",
            "message": "Success rate: ${{ steps.monitor.outputs.success-rate }}% (Status: ${{ steps.monitor.outputs.status }}, Trend: ${{ steps.monitor.outputs.trend }})",
            "details": {
              "success_rate": ${{ steps.monitor.outputs.success-rate }},
              "trend": "${{ steps.monitor.outputs.trend }}",
              "status": "${{ steps.monitor.outputs.status }}",
              "workflow_run": "${{ github.run_id }}",
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}"
            },
            "timestamp": "${{ github.event.head_commit.timestamp }}",
            "source": "github-actions-healing-monitor"
          }' \
          --fail || echo "‚ö†Ô∏è Webhook notification failed"

    - name: üö® Create GitHub issue alert (if critical)
      if: steps.monitor.outputs.status == 'critical' || failure()
      uses: actions/github-script@v7
      with:
        script: |
          const successRate = '${{ steps.monitor.outputs.success-rate }}' || 'unknown';
          const trend = '${{ steps.monitor.outputs.trend }}' || 'unknown';
          const status = '${{ steps.monitor.outputs.status }}' || 'failed';
          const runId = '${{ github.run_id }}';

          const title = `üö® CRITICAL: Healing Success Rate Alert - ${successRate}% (${new Date().toISOString().split('T')[0]})`;

          const body = `## üö® Critical Healing Success Rate Alert

          **Current Status**: ‚ö†Ô∏è ${status.toUpperCase()}
          **Success Rate**: ${successRate}%
          **Trend**: ${trend}
          **Detection Time**: ${new Date().toISOString()}
          **Workflow Run**: [${runId}](https://github.com/${{ github.repository }}/actions/runs/${runId})

          ### üìä Alert Details

          ${status === 'critical' ?
            'üö® **CRITICAL**: Success rate has fallen below 75% minimum threshold.' :
            '‚ö†Ô∏è **WARNING**: Success rate below target 81.1% threshold or monitoring failure detected.'
          }

          ### üîç Immediate Investigation Required

          1. **üîé Check Latest Run**: Review workflow artifacts and test results
          2. **üìà Analyze Trends**: Examine healing-metrics/ for degradation patterns
          3. **üß™ Test Validation**: Verify test environment and dependencies
          4. **üîß Healing Patterns**: Check if existing patterns need updates

          ### üöÄ Recommended Actions

          - [ ] **Download artifacts**: Review healing-data-${runId} for detailed metrics
          - [ ] **Run local analysis**: \`npm run analyze:failures\` and \`npm run analyze:healing-trends\`
          - [ ] **Check recent changes**: Review commits for test-affecting modifications
          - [ ] **Validate environment**: Ensure CI environment matches development setup
          - [ ] **Update healing patterns**: Apply new patterns if recurring failures found
          - [ ] **Monitor recovery**: Track subsequent runs for improvement

          ### üìã Monitoring Resources

          - **üé≠ Dashboard**: Local healing dashboard at http://localhost:8081
          - **üìä Metrics API**: \`curl http://localhost:8081/api/status\`
          - **üìà Trend Analysis**: Check healing-reports/ directory in artifacts
          - **üîß Alert System**: Run \`npm run alert:system\` locally for detailed analysis

          ### üèÜ Success Baseline

          - **Target**: ‚â•81.1% success rate (healing effectiveness baseline)
          - **Minimum**: ‚â•75% success rate (critical threshold)
          - **Trend Goal**: Stable or improving trend direction

          ---

          _Alert generated by üé≠ Playwright Healing Success Monitor_
          _Workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_
          `;

          try {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['üö® healing-alert', 'üé≠ monitoring', status === 'critical' ? 'üî• critical' : '‚ö†Ô∏è warning']
            });

            console.log('‚úÖ Alert issue created successfully');
          } catch (error) {
            console.error('‚ùå Failed to create alert issue:', error.message);
          }

  # Job for generating status summary
  status-summary:
    name: üìã Generate Status Summary
    needs: monitor-healing
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: üìä Create workflow summary
      run: |
        SUCCESS_RATE="${{ needs.monitor-healing.outputs.success-rate }}"
        TREND="${{ needs.monitor-healing.outputs.trend }}"
        STATUS="${{ needs.monitor-healing.outputs.status }}"

        # Determine emoji and color based on status
        if [ "$STATUS" = "healthy" ]; then
          EMOJI="‚úÖ"
          COLOR="green"
        elif [ "$STATUS" = "warning" ]; then
          EMOJI="‚ö†Ô∏è"
          COLOR="yellow"
        else
          EMOJI="üö®"
          COLOR="red"
        fi

        # Trend emoji
        case "$TREND" in
          "improving") TREND_EMOJI="üìà" ;;
          "degrading") TREND_EMOJI="üìâ" ;;
          *) TREND_EMOJI="‚û°Ô∏è" ;;
        esac

        cat >> $GITHUB_STEP_SUMMARY << EOF
        # üé≠ Playwright Healing Success Monitor

        ## üìä Current Status: $EMOJI $STATUS

        | Metric | Value | Target |
        |--------|--------|--------|
        | **Success Rate** | $EMOJI $SUCCESS_RATE% | ‚â•81.1% |
        | **Trend** | $TREND_EMOJI $TREND | Stable/Improving |
        | **Status** | $EMOJI $STATUS | Healthy |

        ## üìà Assessment

        $(if [ "$STATUS" = "healthy" ]; then echo "üéâ **Excellent**: Healing system is performing optimally!"; fi)
        $(if [ "$STATUS" = "warning" ]; then echo "‚ö†Ô∏è **Attention**: Success rate below target - monitoring for improvement"; fi)
        $(if [ "$STATUS" = "critical" ]; then echo "üö® **Action Required**: Critical success rate threshold breached"; fi)

        ## üîß Quick Actions

        - üìä **Monitor Dashboard**: \`npm run dashboard\` (http://localhost:8081)
        - üîç **Analyze Trends**: \`npm run analyze:healing-trends\`
        - üö® **Check Alerts**: \`npm run alert:system\`
        - üìã **View Reports**: Check healing-reports/ directory

        ---
        _Generated by üé≠ Playwright Healing Success Monitor at $(date -u)_
        EOF

  # New job for generating dashboard data for Jekyll site
  update-dashboard:
    name: üìä Update Dashboard Data
    needs: monitor-healing
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && always()

    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üöÄ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üìä Generate dashboard data
      run: |
        echo "Generating dashboard data..."
        mkdir -p dashboard

        # Extract current metrics
        SUCCESS_RATE="${{ needs.monitor-healing.outputs.success-rate || '0' }}"
        TREND="${{ needs.monitor-healing.outputs.trend || 'unknown' }}"
        STATUS="${{ needs.monitor-healing.outputs.status || 'unknown' }}"

        # Calculate current day's metrics
        CURRENT_DATE=$(date +%Y-%m-%d)
        CURRENT_PASSING=$(node -e "console.log(Math.round(135 * $SUCCESS_RATE / 100))")
        TIMESTAMP=$(date -u --iso-8601=seconds)

        # Export variables for Node.js script
        export CURRENT_DATE
        export SUCCESS_RATE
        export CURRENT_PASSING
        export TIMESTAMP
        export REPOSITORY="${{ github.repository }}"
        export WORKFLOW_RUN="${{ github.run_id }}"
        export STATUS

        # Use Node.js to properly handle JSON and accumulate trend data
        node << 'EOJS'
        const fs = require('fs');

        const dashboardFile = 'dashboard/dashboard-data.json';
        const currentDate = process.env.CURRENT_DATE;
        const successRate = parseFloat(process.env.SUCCESS_RATE) || 0;
        const currentPassing = parseInt(process.env.CURRENT_PASSING) || 0;
        const status = process.env.STATUS;
        const timestamp = process.env.TIMESTAMP;
        const repository = process.env.REPOSITORY;
        const workflowRun = process.env.WORKFLOW_RUN;

        // Read existing data or start fresh
        let existingTrend = [];
        try {
          if (fs.existsSync(dashboardFile)) {
            const existingData = JSON.parse(fs.readFileSync(dashboardFile, 'utf8'));
            existingTrend = existingData.trend || [];
            console.log(`Loaded ${existingTrend.length} existing trend entries`);
          }
        } catch (e) {
          console.log('No existing dashboard data found, starting fresh');
        }

        // Create today's entry
        const todayEntry = {
          date: currentDate,
          successRate: successRate,
          totalTests: 135,
          passingTests: currentPassing
        };

        // Check if today's entry already exists and update it, or add new
        const existingIndex = existingTrend.findIndex(e => e.date === currentDate);
        if (existingIndex >= 0) {
          existingTrend[existingIndex] = todayEntry;
          console.log(`Updated existing entry for ${currentDate}`);
        } else {
          existingTrend.push(todayEntry);
          console.log(`Added new entry for ${currentDate}`);
        }

        // Sort by date and keep last 30 days
        existingTrend.sort((a, b) => a.date.localeCompare(b.date));
        if (existingTrend.length > 30) {
          existingTrend = existingTrend.slice(-30);
        }

        // Create the final dashboard data
        const dashboardData = {
          timestamp: timestamp,
          metrics: {
            totalTests: 135,
            passingTests: currentPassing,
            healingSuccessRate: successRate,
            lastRunDuration: 284
          },
          trend: existingTrend,
          status: status,
          repository: repository,
          workflowRun: workflowRun,
          lastUpdated: timestamp
        };

        // Write the file with proper formatting
        fs.writeFileSync(dashboardFile, JSON.stringify(dashboardData, null, 2));
        console.log('Dashboard data generated successfully');
        console.log(`Total trend entries: ${existingTrend.length}`);
        EOJS

        cat dashboard/dashboard-data.json

    - name: üíæ Commit dashboard data
      run: |
        git config --local user.email "dashboard-updater@github.com"
        git config --local user.name "üìä Dashboard Updater"

        # Add dashboard data
        git add dashboard/ || true

        if ! git diff --staged --quiet; then
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "üìä dashboard: update healing metrics - $TIMESTAMP

          - Success Rate: ${{ needs.monitor-healing.outputs.success-rate }}%
          - Status: ${{ needs.monitor-healing.outputs.status }}
          - Trend: ${{ needs.monitor-healing.outputs.trend }}
          - Workflow: ${{ github.run_id }}

          Co-Authored-By: Dashboard Updater <dashboard-updater@github.com>"

          git push || echo "‚ö†Ô∏è Failed to push dashboard data"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi

    - name: ‚úÖ Dashboard update summary
      run: |
        echo "Dashboard data updated successfully!"
        echo "Available at: https://oviney.github.io/blog/dashboard/"
        echo "Success Rate: ${{ needs.monitor-healing.outputs.success-rate }}%"
        echo "Status: ${{ needs.monitor-healing.outputs.status }}"